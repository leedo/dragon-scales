#!/usr/bin/env perl

use v5.14;

use Getopt::Long;
use AnyEvent::rrdcached;
use Twiggy::Server;
use Plack::Builder;

my $dir;
my %twiggy = (host => "0.0.0.0", port => 5000);

GetOptions(
  "cachedir=s" => \$dir,
  "listen=s" => \($twiggy{listen}),
  "port=s"   => \($twiggy{port}),
  "host=s"   => \($twiggy{host}),
);

my $rrdcached = AnyEvent::rrdcached->new($dir);
$rrdcached->spawn->recv;

my @batches;
my $app = builder {
  mount "/dragon" => sub {
    my $env = shift;
    sub {
      my $respond = shift;

      # take batch out of rotation
      if (@batches and $batches[0][1] > 5) {
        my $batch = shift @batches;
        $rrdcached->batch_complete($batch->[0], sub {
          my ($res, $err) = @_;
          warn $err if $err;
        });
      }

      my $done = sub {
        my $batch = shift;
        $batch->[1]++;
        $rrdcached->batch_command($batch->[0], "FARTS");
        $respond->([200, ["Content-Type", "text/plain"], ["ok"]]);
      };

      if (!@batches) {
        return $rrdcached->command("BATCH", sub {
          my ($batch, $err) = @_;
          warn $err if $err;
          push @batches, [$batch, 0];
          $done->($batches[-1]);
        });
      }

      $done->($batches[0]);
    };
  };
};

Twiggy::Server->new(%twiggy)->run($app);
